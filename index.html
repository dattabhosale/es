<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeapReplica - Electric Vehicles</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="/" class="brand">LeapReplica</a>
      <nav class="site-nav" id="site-nav">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">â˜°</button>
    </div>
  </header>
  <main>
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-copy">
          <h1>Electric mobility, designed for the future.</h1>
          <p>Explore a new generation of electric vehicles with long range, smart features, and bold design.</p>
          <p><a class="btn" href="products.html">View Models</a></p>
        </div>
        <div class="hero-media">
          <img src="assets/car-hero.jpg" alt="Electric car mockup">
        </div>
      </div>
    </section>
    <section class="highlights">
      <div class="container">
        <h2>Featured Models</h2>
        <div class="cards">
          <article class="card">
            <img src="assets/model-a.jpg" alt="Model A">
            <h3>Model A</h3>
            <p>Long range, fast charging, advanced driver assistance.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-b.jpg" alt="Model B">
            <h3>Model B</h3>
            <p>Urban performance with compact design and premium interior.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-c.jpg" alt="Model C">
            <h3>Model C</h3>
            <p>An intelligent SUV with family-friendly range and space.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
        </div>
      </div>
    </section>
    <section class="about-teaser">
      <div class="container">
        <h2>Our Vision</h2>
        <p>We build electric vehicles that are safe, sustainable and delightful to drive. Technology and design come
          together to make mobility more efficient and enjoyable.</p>
        <p><a class="btn ghost" href="about.html">Learn about us</a></p>
      </div>
    </section>
  </main>
  <footer class="site-footer">
    <div class="container">
      <div>Â© 2025 LeapReplica</div>
      <nav class="foot-nav">
        <a href="privacy.html">Privacy</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </footer>
<script type='text/javascript'>
/**
* Salesforce Embedded Messaging - Improved Implementation
* Fixes: Dynamic country settings, race conditions, performance optimizations
*/
// ======================== CONFIGURATION =========================
const ESW_CONFIG = {
â€ƒâ€ƒORG_ID: '00DMA000003XnGM',
â€ƒâ€ƒDEPLOYMENT_NAME: 'LPM_Leapmotor',
â€ƒâ€ƒSITE_URL: 'https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231',
â€ƒâ€ƒSCRT2_URL: 'https://leapmotor--dev01.sandbox.my.salesforce-scrt.com',

â€ƒâ€ƒCOUNTRY_MAPPING: {
â€ƒâ€ƒâ€ƒâ€ƒ'it': { name: 'Italy', language: 'it', code: 'it' },
â€ƒâ€ƒâ€ƒâ€ƒ'es': { name: 'Spain', language: 'es', code: 'es' },
â€ƒâ€ƒâ€ƒâ€ƒ'fr': { name: 'France', language: 'fr', code: 'fr' },
â€ƒâ€ƒâ€ƒâ€ƒ'de': { name: 'Germany', language: 'de', code: 'de' },
â€ƒâ€ƒâ€ƒâ€ƒ'uk': { name: 'United Kingdom', language: 'en_US', code: 'uk' },
â€ƒâ€ƒâ€ƒâ€ƒ'us': { name: 'United States', language: 'en_US', code: 'us' },
â€ƒâ€ƒâ€ƒâ€ƒ'en': { name: 'United States', language: 'en_US', code: 'en' }
â€ƒâ€ƒ},

â€ƒâ€ƒDEFAULT_COUNTRY: 'en'
};
/**
* Extract country code from URL pathname
* @returns {string} Country code (defaults to 'en')
*/
function getCountryCodeFromPath() {
â€ƒâ€ƒconst pathParts = window.location.pathname
â€ƒâ€ƒâ€ƒâ€ƒ.split('/')
â€ƒâ€ƒâ€ƒâ€ƒ.filter(function(part) { return part.length > 0; });

â€ƒâ€ƒreturn pathParts.length > 0 ? pathParts[0].toLowerCase() : ESW_CONFIG.DEFAULT_COUNTRY;
}
/**
* Get country information based on country code
* @param {string} countryCode - Two-letter country code
* @returns {Object} Country information object
*/
function getCountryInfo(countryCode) {
â€ƒâ€ƒreturn ESW_CONFIG.COUNTRY_MAPPING[countryCode] || ESW_CONFIG.COUNTRY_MAPPING[ESW_CONFIG.DEFAULT_COUNTRY];
}
/**
* Initialize Embedded Messaging with dynamic country settings
*/
function initEmbeddedMessaging() {
â€ƒâ€ƒtry {
â€ƒâ€ƒâ€ƒâ€ƒconst countryCode = getCountryCodeFromPath();
â€ƒâ€ƒâ€ƒâ€ƒconst countryInfo = getCountryInfo(countryCode);

â€ƒâ€ƒâ€ƒâ€ƒ// Configure embedded service settings
â€ƒâ€ƒâ€ƒâ€ƒembeddedservice_bootstrap.settings.shouldOpenLinksInSameTab = true;
â€ƒâ€ƒâ€ƒâ€ƒembeddedservice_bootstrap.settings.language = countryInfo.language;

â€ƒâ€ƒâ€ƒâ€ƒ// Set up pre-chat fields with dynamic country info
â€ƒâ€ƒâ€ƒâ€ƒwindow.addEventListener("onEmbeddedMessagingReady", function() {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒembeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒCountry: countryInfo.name,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒLanguage: countryInfo.language,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒCountryCode: countryInfo.code
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ});
â€ƒâ€ƒâ€ƒâ€ƒ});

â€ƒâ€ƒâ€ƒâ€ƒ// Initialize the embedded service
â€ƒâ€ƒâ€ƒâ€ƒembeddedservice_bootstrap.init(
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒESW_CONFIG.ORG_ID,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒESW_CONFIG.DEPLOYMENT_NAME,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒESW_CONFIG.SITE_URL,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ{
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒscrt2URL: ESW_CONFIG.SCRT2_URL
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒ);
â€ƒâ€ƒ} catch (err) {
â€ƒâ€ƒâ€ƒâ€ƒconsole.error('[ESW] Error loading Embedded Messaging:', err);
â€ƒâ€ƒ}
}
</script>
<!-- ======================== ADVANCED CONTROL ======================== -->
<script type='text/javascript'>
<!-- ======================== ADVANCED CONTROL ======================== -->
(function () {
â€ƒâ€ƒ'use strict';

â€ƒâ€ƒ/* ====== Configuration ====== */
â€ƒâ€ƒconst CONFIG = {
â€ƒâ€ƒâ€ƒâ€ƒNUDGE_DELAY_MS: 30000,
â€ƒâ€ƒâ€ƒâ€ƒDESKTOP_MIN_WIDTH: 1025,
â€ƒâ€ƒâ€ƒâ€ƒSTATE_POLL_INTERVAL_MS: 1000,
â€ƒâ€ƒâ€ƒâ€ƒMIN_CHAT_HEIGHT: 150,
â€ƒâ€ƒâ€ƒâ€ƒMIN_CHAT_WIDTH: 200,
â€ƒâ€ƒâ€ƒâ€ƒRETRY_DELAYS: [80, 220, 500]
â€ƒâ€ƒ};

â€ƒâ€ƒconst MESSAGES = {
â€ƒâ€ƒâ€ƒâ€ƒes: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: 'Â¡Habla conmigo!',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: 'Â¡Sigue hablÃ¡ndome!'
â€ƒâ€ƒâ€ƒâ€ƒ},
â€ƒâ€ƒâ€ƒâ€ƒit: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: 'Parlami!',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: 'Continua a parlarmi!'
â€ƒâ€ƒâ€ƒâ€ƒ},
â€ƒâ€ƒâ€ƒâ€ƒfr: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: 'Parle-moi!',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: 'Continue de me parler!'
â€ƒâ€ƒâ€ƒâ€ƒ},
â€ƒâ€ƒâ€ƒâ€ƒde: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: 'Sprich mit mir!',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: 'Sprich weiter mit mir!'
â€ƒâ€ƒâ€ƒâ€ƒ},
â€ƒâ€ƒâ€ƒâ€ƒen: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: 'Talk to me!',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: 'Keep talking to me!'
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ};

â€ƒâ€ƒ/* ====== State ====== */
â€ƒâ€ƒconst state = {
â€ƒâ€ƒâ€ƒâ€ƒchatEverOpened: false,
â€ƒâ€ƒâ€ƒâ€ƒchatCurrentlyOpen: false,
â€ƒâ€ƒâ€ƒâ€ƒnudgeElement: null,
â€ƒâ€ƒâ€ƒâ€ƒnudgeBottomPosition: null,

â€ƒâ€ƒâ€ƒâ€ƒtimers: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfirst: null,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfollowup: null
â€ƒâ€ƒâ€ƒâ€ƒ},

â€ƒâ€ƒâ€ƒâ€ƒobservers: {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlauncher: null,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒbody: null,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfixedRoot: null,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstatePoller: null
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ};

â€ƒâ€ƒ/* ====== Utility Functions ====== */
â€ƒâ€ƒconst isMobile = () => window.innerWidth < CONFIG.DESKTOP_MIN_WIDTH;

â€ƒâ€ƒfunction getCountryCode() {
â€ƒâ€ƒâ€ƒâ€ƒreturn getCountryCodeFromPath();
â€ƒâ€ƒ}

â€ƒâ€ƒfunction getLocalizedMessages() {
â€ƒâ€ƒâ€ƒâ€ƒconst code = getCountryCode();
â€ƒâ€ƒ   console.log('message code');
â€ƒâ€ƒâ€ƒâ€ƒreturn MESSAGES[code] || MESSAGES.en;
â€ƒâ€ƒ}

â€ƒâ€ƒfunction clearTimer(timerName) {
â€ƒâ€ƒâ€ƒâ€ƒif (state.timers[timerName]) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log(`[TIMER] Clearing ${timerName} timer`);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒclearTimeout(state.timers[timerName]);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.timers[timerName] = null;
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒfunction clearAllTimers() {
â€ƒâ€ƒâ€ƒâ€ƒclearTimer('first');
â€ƒâ€ƒâ€ƒâ€ƒclearTimer('followup');
â€ƒâ€ƒ}

â€ƒâ€ƒfunction disconnectObserver(observerName) {
â€ƒâ€ƒâ€ƒâ€ƒif (state.observers[observerName]) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers[observerName].disconnect();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers[observerName] = null;
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== DOM Element Getters ====== */
â€ƒâ€ƒfunction getLauncherEl() {
â€ƒâ€ƒâ€ƒâ€ƒreturn (
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('.embeddedServiceLauncher') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('.embeddedServiceSidebarButton') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('[data-embedded-messaging-launcher]') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('#embedded-messaging .embeddedMessagingIcon') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('#embedded-messaging button') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('button[class*="Launcher"], div[class*="Launcher"]')
â€ƒâ€ƒâ€ƒâ€ƒ);
â€ƒâ€ƒ}

â€ƒâ€ƒfunction getChatFrameEl() {
â€ƒâ€ƒâ€ƒâ€ƒreturn (
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('.embeddedMessagingFrame') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('iframe[data-embedded-messaging-iframe]') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('iframe[src*="embeddedmessaging"]') ||
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.querySelector('iframe[id*="embeddedMessaging"]')
â€ƒâ€ƒâ€ƒâ€ƒ);
â€ƒâ€ƒ}

â€ƒâ€ƒfunction getFixedRootEl() {
â€ƒâ€ƒâ€ƒâ€ƒconst frame = getChatFrameEl();
â€ƒâ€ƒâ€ƒâ€ƒif (!frame) return null;

â€ƒâ€ƒâ€ƒâ€ƒlet el = frame;
â€ƒâ€ƒâ€ƒâ€ƒwhile (el && el !== document.body) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst cs = getComputedStyle(el);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (cs.position === 'fixed') return el;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒel = el.parentElement;
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒreturn document.querySelector('#embedded-messaging') || null;
â€ƒâ€ƒ}

â€ƒâ€ƒfunction getHeaderEl() {
â€ƒâ€ƒâ€ƒâ€ƒconst fromAttr = document.body?.getAttribute?.('data-esw-header');
â€ƒâ€ƒâ€ƒâ€ƒconst candidates = (fromAttr ? fromAttr.split(',') : [])
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ.map(s => s.trim())
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ.filter(Boolean);

â€ƒâ€ƒâ€ƒâ€ƒconst defaults = [
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ'header.site-header', 'header.navbar', 'header#header', '#site-header',
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ'header.header', 'header', '.topbar', '.navbar'
â€ƒâ€ƒâ€ƒâ€ƒ];

â€ƒâ€ƒâ€ƒâ€ƒfor (const sel of [...candidates, ...defaults]) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst el = document.querySelector(sel);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (el) return el;
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒreturn null;
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Header Height Management ====== */
â€ƒâ€ƒfunction updateHeaderHeightVar() {
â€ƒâ€ƒâ€ƒâ€ƒconst h = getHeaderEl()?.offsetHeight || 60;
â€ƒâ€ƒâ€ƒâ€ƒdocument.documentElement.style.setProperty('--site-header-height', h + 'px');
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Style Locking ====== */
â€ƒâ€ƒfunction lockLauncherStyle() {
â€ƒâ€ƒâ€ƒâ€ƒconst launcher = getLauncherEl();
â€ƒâ€ƒâ€ƒâ€ƒif (!launcher) return;

â€ƒâ€ƒâ€ƒâ€ƒconst cs = getComputedStyle(document.documentElement);
â€ƒâ€ƒâ€ƒâ€ƒconst bottom = cs.getPropertyValue('--chat-launcher-bottom').trim() || '60px';
â€ƒâ€ƒâ€ƒâ€ƒconst right = cs.getPropertyValue('--chat-launcher-right').trim() || '30px';

â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.position = 'fixed';
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.bottom = bottom;
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.right = right;
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.left = 'auto';
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.top = 'auto';
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.transform = 'none';
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.transition = 'none';
â€ƒâ€ƒâ€ƒâ€ƒlauncher.style.zIndex = '2147483647';

â€ƒâ€ƒâ€ƒâ€ƒupdateNudgePosition();
â€ƒâ€ƒ}

â€ƒâ€ƒfunction lockFixedRootStyle() {
â€ƒâ€ƒâ€ƒâ€ƒconst root = getFixedRootEl();
â€ƒâ€ƒâ€ƒâ€ƒif (!root) return;

â€ƒâ€ƒâ€ƒâ€ƒif (!isMobile()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst cs = getComputedStyle(document.documentElement);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst gap = cs.getPropertyValue('--chat-frame-bottom-gap').trim() || '40px';
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst rightGap = cs.getPropertyValue('--chat-frame-right-gap').trim() || '30px';

â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.position = 'fixed';
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.top = 'auto';
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.left = 'auto';
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.right = rightGap;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.bottom = gap;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.inset = 'auto ' + rightGap + ' ' + gap + ' auto';
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒroot.style.zIndex = '2147483645';
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒfunction applyStylesWithRetry() {
â€ƒâ€ƒâ€ƒâ€ƒlockLauncherStyle();
â€ƒâ€ƒâ€ƒâ€ƒlockFixedRootStyle();

â€ƒâ€ƒâ€ƒâ€ƒCONFIG.RETRY_DELAYS.forEach(delay => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒsetTimeout(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockLauncherStyle();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockFixedRootStyle();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}, delay);
â€ƒâ€ƒâ€ƒâ€ƒ});
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Observer Setup ====== */
â€ƒâ€ƒfunction observeDynamicElements() {
â€ƒâ€ƒâ€ƒâ€ƒ// Launcher observer
â€ƒâ€ƒâ€ƒâ€ƒdisconnectObserver('launcher');
â€ƒâ€ƒâ€ƒâ€ƒconst launcher = getLauncherEl();
â€ƒâ€ƒâ€ƒâ€ƒif (launcher) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.launcher = new MutationObserver(() => lockLauncherStyle());
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.launcher.observe(launcher, {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒattributes: true,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒattributeFilter: ['style', 'class', 'aria-expanded', 'aria-pressed']
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ});

â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlauncher.addEventListener('click', () => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒsetTimeout(evaluateAndApplyOpenState, 350);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}, { capture: true, once: false });
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒ// Fixed root observer
â€ƒâ€ƒâ€ƒâ€ƒdisconnectObserver('fixedRoot');
â€ƒâ€ƒâ€ƒâ€ƒconst root = getFixedRootEl();
â€ƒâ€ƒâ€ƒâ€ƒif (root) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.fixedRoot = new MutationObserver(() => lockFixedRootStyle());
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.fixedRoot.observe(root, {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒattributes: true,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒattributeFilter: ['style', 'class']
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ});
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒ// Body observer (only set up once)
â€ƒâ€ƒâ€ƒâ€ƒif (!state.observers.body) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.body = new MutationObserver(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockLauncherStyle();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockFixedRootStyle();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ});
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.observers.body.observe(document.body, {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒchildList: true,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒsubtree: true
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ});
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Nudge Management ====== */
â€ƒâ€ƒfunction showNudge(message) {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Attempting to show nudge:', message);

â€ƒâ€ƒâ€ƒâ€ƒif (state.nudgeElement) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Nudge already visible, skipping');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒreturn;
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement = document.createElement('div');
â€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.className = 'chat-nudge';
â€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.textContent = message;

â€ƒâ€ƒâ€ƒâ€ƒconst closeBtn = document.createElement('span');
â€ƒâ€ƒâ€ƒâ€ƒcloseBtn.className = 'close-btn';
â€ƒâ€ƒâ€ƒâ€ƒcloseBtn.textContent = 'Ã—';
â€ƒâ€ƒâ€ƒâ€ƒcloseBtn.onclick = function (e) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Closed manually');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒe.stopPropagation();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒremoveNudge();
â€ƒâ€ƒâ€ƒâ€ƒ};
â€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.appendChild(closeBtn);

â€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.onclick = function () {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Clicked - opening chat');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒwindow.embeddedservice_bootstrap?.open?.();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒremoveNudge();
â€ƒâ€ƒâ€ƒâ€ƒ};

â€ƒâ€ƒâ€ƒâ€ƒdocument.body.appendChild(state.nudgeElement);

â€ƒâ€ƒâ€ƒâ€ƒif (!isMobile()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (state.nudgeBottomPosition === null) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst launcher = getLauncherEl();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (launcher) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst rect = launcher.getBoundingClientRect();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst bottom = Math.max(0, window.innerHeight - rect.top + 20);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst maxBottom = window.innerHeight - 50;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst minBottom = 20;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeBottomPosition = Math.min(Math.max(bottom, minBottom), maxBottom);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.style.bottom = state.nudgeBottomPosition + 'px';
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Nudge displayed');
â€ƒâ€ƒ}

â€ƒâ€ƒfunction removeNudge() {
â€ƒâ€ƒâ€ƒâ€ƒif (state.nudgeElement) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] Removing nudge');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.remove();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement = null;
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒfunction updateNudgePosition() {
â€ƒâ€ƒâ€ƒâ€ƒif (isMobile() || !state.nudgeElement) return;

â€ƒâ€ƒâ€ƒâ€ƒconst launcher = getLauncherEl();
â€ƒâ€ƒâ€ƒâ€ƒif (launcher) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (state.nudgeBottomPosition === null) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst rect = launcher.getBoundingClientRect();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst bottom = Math.max(0, window.innerHeight - rect.top + 20);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst maxBottom = window.innerHeight - 50;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst minBottom = 20;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeBottomPosition = Math.min(Math.max(bottom, minBottom), maxBottom);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.nudgeElement.style.bottom = state.nudgeBottomPosition + 'px';
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== State Detection ====== */
â€ƒâ€ƒfunction isOpenState() {
â€ƒâ€ƒâ€ƒâ€ƒconst frame = getChatFrameEl();
â€ƒâ€ƒâ€ƒâ€ƒconst root = getFixedRootEl();

â€ƒâ€ƒâ€ƒâ€ƒif (!frame || !root) return false;

â€ƒâ€ƒâ€ƒâ€ƒconst fs = getComputedStyle(frame);
â€ƒâ€ƒâ€ƒâ€ƒconst fr = frame.getBoundingClientRect();
â€ƒâ€ƒâ€ƒâ€ƒconst rs = getComputedStyle(root);
â€ƒâ€ƒâ€ƒâ€ƒconst rr = root.getBoundingClientRect();

â€ƒâ€ƒâ€ƒâ€ƒconst frameVisible = (
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfs.display !== 'none' &&
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfs.visibility !== 'hidden' &&
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfr.height > CONFIG.MIN_CHAT_HEIGHT &&
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒfr.width > CONFIG.MIN_CHAT_WIDTH
â€ƒâ€ƒâ€ƒâ€ƒ);

â€ƒâ€ƒâ€ƒâ€ƒconst rootLarge = (rr.height > CONFIG.MIN_CHAT_HEIGHT);

â€ƒâ€ƒâ€ƒâ€ƒreturn frameVisible && rootLarge;
â€ƒâ€ƒ}

â€ƒâ€ƒfunction evaluateAndApplyOpenState() {
â€ƒâ€ƒâ€ƒâ€ƒconst nowOpen = isOpenState();
â€ƒâ€ƒâ€ƒâ€ƒconst wasOpen = state.chatCurrentlyOpen;

â€ƒâ€ƒâ€ƒâ€ƒ// No state change
â€ƒâ€ƒâ€ƒâ€ƒif (nowOpen === wasOpen) return;

â€ƒâ€ƒâ€ƒâ€ƒ// Transition: open â†’ minimized
â€ƒâ€ƒâ€ƒâ€ƒif (wasOpen && !nowOpen) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[STATE] Chat minimized');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = false;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.remove('esw-open');

â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ// Only show follow-up nudge if chat was previously opened
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (state.chatEverOpened) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒclearTimer('followup');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst messages = getLocalizedMessages();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[FOLLOWUP] Scheduling follow-up nudge');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.timers.followup = setTimeout(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[FOLLOWUP] Showing follow-up nudge');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (!isOpenState()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒshowNudge(messages.followup);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}, CONFIG.NUDGE_DELAY_MS);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒ// Transition: minimized â†’ open
â€ƒâ€ƒâ€ƒâ€ƒif (!wasOpen && nowOpen) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[STATE] Chat opened');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = true;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.chatEverOpened = true;
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.add('esw-open');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒremoveNudge();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒclearAllTimers();
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ}

â€ƒâ€ƒfunction startStatePolling() {
â€ƒâ€ƒâ€ƒâ€ƒif (state.observers.statePoller) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒclearInterval(state.observers.statePoller);
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = isOpenState();
â€ƒâ€ƒâ€ƒâ€ƒstate.observers.statePoller = setInterval(
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒevaluateAndApplyOpenState,
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒCONFIG.STATE_POLL_INTERVAL_MS
â€ƒâ€ƒâ€ƒâ€ƒ);
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Event Handlers ====== */
â€ƒâ€ƒfunction handleResize() {
â€ƒâ€ƒâ€ƒâ€ƒupdateHeaderHeightVar();
â€ƒâ€ƒâ€ƒâ€ƒupdateNudgePosition();

â€ƒâ€ƒâ€ƒâ€ƒif (isMobile() && isOpenState()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[RESIZE] Mobile + chat open, skipping relayout');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒreturn;
â€ƒâ€ƒâ€ƒâ€ƒ}

â€ƒâ€ƒâ€ƒâ€ƒsetTimeout(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockLauncherStyle();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒlockFixedRootStyle();
â€ƒâ€ƒâ€ƒâ€ƒ}, 50);
â€ƒâ€ƒ}

â€ƒâ€ƒ/* ====== Salesforce Events ====== */
â€ƒâ€ƒwindow.addEventListener('onEmbeddedMessagingReady', function () {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[ESW] Embedded Messaging Ready');
â€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.add('chat-launcher-fixed');

â€ƒâ€ƒâ€ƒâ€ƒupdateHeaderHeightVar();
â€ƒâ€ƒâ€ƒâ€ƒapplyStylesWithRetry();
â€ƒâ€ƒâ€ƒâ€ƒobserveDynamicElements();
â€ƒâ€ƒâ€ƒâ€ƒstartStatePolling();

â€ƒâ€ƒâ€ƒâ€ƒwindow.addEventListener('resize', handleResize);

â€ƒâ€ƒâ€ƒâ€ƒ// Schedule first nudge only if chat never opened
â€ƒâ€ƒâ€ƒâ€ƒclearTimer('first');
â€ƒâ€ƒâ€ƒâ€ƒconst messages = getLocalizedMessages();
â€ƒâ€ƒâ€ƒâ€ƒstate.timers.first = setTimeout(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[NUDGE] First timer expired');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (!state.chatEverOpened && !isOpenState()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒshowNudge(messages.first);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒ}, CONFIG.NUDGE_DELAY_MS);
â€ƒâ€ƒ});

â€ƒâ€ƒwindow.addEventListener('onEmbeddedMessagingButtonClicked', function () {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[ESW] Button clicked');
â€ƒâ€ƒâ€ƒâ€ƒsetTimeout(evaluateAndApplyOpenState, 250);
â€ƒâ€ƒ});

â€ƒâ€ƒwindow.addEventListener('onEmbeddedMessagingWindowOpened', function () {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[ESW] Window opened event');
â€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = true;
â€ƒâ€ƒâ€ƒâ€ƒstate.chatEverOpened = true;
â€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.add('esw-open');
â€ƒâ€ƒâ€ƒâ€ƒremoveNudge();
â€ƒâ€ƒâ€ƒâ€ƒclearAllTimers();

â€ƒâ€ƒâ€ƒâ€ƒsetTimeout(applyStylesWithRetry, 50);
â€ƒâ€ƒ});

â€ƒâ€ƒwindow.addEventListener('onEmbeddedMessagingWindowMinimized', function () {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[ESW] Window minimized event');
â€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = false;
â€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.remove('esw-open');

â€ƒâ€ƒâ€ƒâ€ƒsetTimeout(applyStylesWithRetry, 50);

â€ƒâ€ƒâ€ƒâ€ƒif (state.chatEverOpened) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒclearTimer('followup');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconst messages = getLocalizedMessages();
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[FOLLOWUP] Scheduling follow-up nudge (event)');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒstate.timers.followup = setTimeout(() => {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒconsole.log('[FOLLOWUP] Showing follow-up nudge (event)');
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒif (!isOpenState()) {
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒshowNudge(messages.followup);
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ}, CONFIG.NUDGE_DELAY_MS);
â€ƒâ€ƒâ€ƒâ€ƒ}
â€ƒâ€ƒ});

â€ƒâ€ƒwindow.addEventListener('onEmbeddedMessagingWindowClosed', function () {
â€ƒâ€ƒâ€ƒâ€ƒconsole.log('[ESW] Window closed event');
â€ƒâ€ƒâ€ƒâ€ƒstate.chatCurrentlyOpen = false;
â€ƒâ€ƒâ€ƒâ€ƒdocument.body.classList.remove('esw-open');
â€ƒâ€ƒâ€ƒâ€ƒsetTimeout(applyStylesWithRetry, 50);
â€ƒâ€ƒ});
})();
</script>
<script>
/* ====== Add-on NON intrusivo (iOS-safe): VisualViewport LOCK ====== */
(function () {
  const root = document.documentElement;
  let baselineVvh = 0;
  let rafPending = false;

  function setVar(name, valuePx) {
    root.style.setProperty(name, Math.max(0, Math.round(valuePx)) + 'px');
  }

  function updateViewportVars() {
    rafPending = false;
    const vv = window.visualViewport;

    if (!vv) {
      const h = window.innerHeight || document.documentElement.clientHeight || 0;
      setVar('--vvh', h);
      setVar('--vvo', 0);
      setVar('--kbBottom', 0);
      return;
    }

    const vvh = vv.height;
    const vvo = vv.offsetTop || 0;

    setVar('--vvh', vvh);
    setVar('--vvo', vvo);

    // baseline (utile anche se non lo usiamo nel lock)
    if (!baselineVvh || vvh > baselineVvh) baselineVvh = vvh;
    setVar('--kbBottom', Math.max(0, baselineVvh - vvh));
  }

  function scheduleUpdate(delay = 0) {
    if (delay) {
      setTimeout(() => scheduleUpdate(0), delay);
      return;
    }
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(updateViewportVars);
  }

  // init
  scheduleUpdate(0);

  window.addEventListener('resize', () => scheduleUpdate(0), { passive: true });
  window.addEventListener('orientationchange', () => {
    baselineVvh = 0;
    scheduleUpdate(120);
  }, { passive: true });

  if (window.visualViewport) {
    visualViewport.addEventListener('resize', () => scheduleUpdate(0), { passive: true });
    visualViewport.addEventListener('scroll', () => scheduleUpdate(0), { passive: true });
  }

  // ğŸ”¥ iOS: dopo tap su â€œInviaâ€ spesso lâ€™assestamento arriva DOPO (80â€“200ms)
  document.addEventListener('click', () => scheduleUpdate(150), { passive: true });
  document.addEventListener('touchend', () => scheduleUpdate(150), { passive: true });

  // focus: apertura/chiusura tastiera
  document.addEventListener('focusin', () => scheduleUpdate(80), { passive: true });
  document.addEventListener('focusout', () => scheduleUpdate(150), { passive: true });

  // mini stabilizer: dopo un click fai 3 refresh ravvicinati (iOS â€œrimbalzaâ€)
  function stabilizeAfterInteraction() {
    scheduleUpdate(0);
    scheduleUpdate(120);
    scheduleUpdate(240);
  }
  document.addEventListener('click', stabilizeAfterInteraction, { passive: true });
})();
</script>
<!-- ======================== CUSTOM STYLES ======================== -->
<style>
:root {
â€ƒâ€ƒ/* Launcher (button) */
â€ƒâ€ƒ--chat-launcher-bottom: 60px;
â€ƒâ€ƒ--chat-launcher-right: 30px;

â€ƒâ€ƒ/* Nudge */
â€ƒâ€ƒ--chat-nudge-offset: 70px;

â€ƒâ€ƒ/* Header mobile */
â€ƒâ€ƒ--chat-header-height: 60px;
â€ƒâ€ƒ--site-header-height: 60px;

â€ƒâ€ƒ/* Desktop: lift chat box from bottom */
â€ƒâ€ƒ--chat-frame-bottom-gap: 40px;
â€ƒâ€ƒ--chat-frame-right-gap: 30px;
}
/* ======= DESKTOP ======= */
@media (min-width: 1025px) {
â€ƒâ€ƒ.embeddedMessagingFrame {
â€ƒâ€ƒâ€ƒâ€ƒborder-radius: 16px !important;
â€ƒâ€ƒâ€ƒâ€ƒoverflow: hidden !important;
â€ƒâ€ƒâ€ƒâ€ƒz-index: 2147483645 !important;
â€ƒâ€ƒ}

â€ƒâ€ƒ.embeddedMessagingHeader {
â€ƒâ€ƒâ€ƒâ€ƒborder-top-left-radius: 16px !important;
â€ƒâ€ƒâ€ƒâ€ƒborder-top-right-radius: 16px !important;
â€ƒâ€ƒ}

â€ƒâ€ƒ.embeddedMessagingConversation {
â€ƒâ€ƒâ€ƒâ€ƒborder-bottom-left-radius: 16px !important;
â€ƒâ€ƒâ€ƒâ€ƒborder-bottom-right-radius: 16px !important;
â€ƒâ€ƒ}
}
/* ======= LAUNCHER FIXED ======= */
.chat-launcher-fixed .embeddedServiceLauncher,
.chat-launcher-fixed .embeddedServiceSidebarButton,
.chat-launcher-fixed #embedded-messaging .embeddedMessagingIcon,
.chat-launcher-fixed button[class*="Launcher"],
.chat-launcher-fixed div[class*="Launcher"] {
â€ƒâ€ƒposition: fixed !important;
â€ƒâ€ƒbottom: var(--chat-launcher-bottom) !important;
â€ƒâ€ƒright: var(--chat-launcher-right) !important;
â€ƒâ€ƒleft: auto !important;
â€ƒâ€ƒtop: auto !important;
â€ƒâ€ƒtransform: none !important;
â€ƒâ€ƒz-index: 2147483647 !important;
}
/* ======= NUDGE ======= */
.chat-nudge {
â€ƒâ€ƒposition: fixed;
â€ƒâ€ƒbottom: calc(var(--chat-launcher-bottom) + var(--chat-nudge-offset));
â€ƒâ€ƒright: var(--chat-launcher-right);
â€ƒâ€ƒbackground: #ffffff;
â€ƒâ€ƒcolor: #000;
â€ƒâ€ƒpadding: 10px 20px 10px 12px;
â€ƒâ€ƒborder-radius: 12px;
â€ƒâ€ƒbox-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
â€ƒâ€ƒfont-size: 14px;
â€ƒâ€ƒfont-weight: 500;
â€ƒâ€ƒz-index: 2147483646;
â€ƒâ€ƒcursor: pointer;
â€ƒâ€ƒanimation: bounce 5s ease-out;
}
@keyframes bounce {
â€ƒâ€ƒ0% { transform: translateY(0); }
â€ƒâ€ƒ20% { transform: translateY(-6px); }
â€ƒâ€ƒ40% { transform: translateY(0); }
â€ƒâ€ƒ60% { transform: translateY(-3px); }
â€ƒâ€ƒ80% { transform: translateY(0); }
â€ƒâ€ƒ100% { transform: translateY(0); }
}
.chat-nudge .close-btn {
â€ƒâ€ƒposition: absolute;
â€ƒâ€ƒtop: 4px;
â€ƒâ€ƒright: 6px;
â€ƒâ€ƒfont-weight: bold;
â€ƒâ€ƒfont-size: 14px;
â€ƒâ€ƒcolor: #666;
â€ƒâ€ƒcursor: pointer;
â€ƒâ€ƒmargin-left: 8px;
}
.chat-nudge .close-btn:hover {
â€ƒâ€ƒcolor: #000;
}


/* ====== MOBILE FULLSCREEN + KEYBOARD SAFE (VisualViewport anchored + LOCK) ====== */
@media (max-width: 1024px) {

  body.esw-open {
    overflow: hidden !important;
    --site-header-height: 0px !important;
    touch-action: none;
    overscroll-behavior: none !important;
  }

  body.esw-open #embedded-messaging,
  body.esw-open .embeddedMessagingFrame,
  body.esw-open iframe[data-embedded-messaging-iframe] {
    position: fixed !important;

    /* Aggancio al visual viewport */
    top: var(--vvo, 0px) !important;
    left: 0 !important;
    right: 0 !important;
    bottom: auto !important;

    /* âœ… LOCK: altezza sempre uguale al visual viewport visibile */
    height: var(--vvh, 100dvh) !important;
    min-height: var(--vvh, 100dvh) !important;
    max-height: var(--vvh, 100dvh) !important;

    width: 100vw !important;
    max-width: 100vw !important;

    /* Safe areas */
    padding-top: env(safe-area-inset-top, 0px) !important;
    padding-bottom: env(safe-area-inset-bottom, 0px) !important;

    border-radius: 0 !important;
    overflow: hidden !important;

    z-index: 2147483647 !important;

    transform: none !important;
    filter: none !important;
    perspective: none !important;

    transition: none !important;
    will-change: top, height;
  }

  @supports not (height: 100dvh) {
    body.esw-open #embedded-messaging,
    body.esw-open .embeddedMessagingFrame,
    body.esw-open iframe[data-embedded-messaging-iframe] {
      height: -webkit-fill-available !important;
      min-height: -webkit-fill-available !important;
      max-height: -webkit-fill-available !important;
    }
  }
}
/* ====== HARD OVERRIDE: forza la nudge ad essere un overlay ====== */
body .chat-nudge {
  position: fixed !important;
  left: auto !important;
  right: var(--chat-launcher-right, 30px) !important;
  top: auto !important;
  bottom: calc(var(--chat-launcher-bottom, 60px) + var(--chat-nudge-offset, 70px)) !important;

  z-index: 2147483647 !important;

  display: inline-flex !important;
  align-items: center !important;
  gap: 8px !important;

  width: max-content !important;
  max-width: calc(100vw - 120px) !important;
  white-space: nowrap !important;

  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;

  transform: translateZ(0) !important; /* iOS/Safari: stabilizza layer */
}
/* ====== FINAL OVERRIDE (DEVE ESSERE L'ULTIMO CSS DELLA PAGINA) ====== */
html body div.chat-nudge.chat-nudge {
  position: fixed !important;
  left: auto !important;
  right: var(--chat-launcher-right, 30px) !important;
  top: auto !important;
  bottom: calc(var(--chat-launcher-bottom, 60px) + var(--chat-nudge-offset, 70px)) !important;

  z-index: 2147483647 !important;

  display: inline-flex !important;
  align-items: center !important;

  width: max-content !important;
  max-width: calc(100vw - 120px) !important;
  white-space: nowrap !important;

  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;

  transform: translateZ(0) !important;
}

html body div.chat-nudge.chat-nudge .close-btn {
  position: absolute !important;
  top: 4px !important;
  right: 6px !important;
}
</style>
  <!-- Load Salesforce Embedded Messaging Bootstrap -->
  <script
    type="text/javascript"
    src="https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231/assets/js/bootstrap.min.js"
    onload="initEmbeddedMessaging()"
  ></script>
 
</body>
</html>
