<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeapReplica - Electric Vehicles</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="/" class="brand">LeapReplica</a>
      <nav class="site-nav" id="site-nav">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">☰</button>
    </div>
  </header>
  <main>
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-copy">
          <h1>Electric mobility, designed for the future.</h1>
          <p>Explore a new generation of electric vehicles with long range, smart features, and bold design.</p>
          <p><a class="btn" href="products.html">View Models</a></p>
        </div>
        <div class="hero-media">
          <img src="assets/car-hero.jpg" alt="Electric car mockup">
        </div>
      </div>
    </section>
    <section class="highlights">
      <div class="container">
        <h2>Featured Models</h2>
        <div class="cards">
          <article class="card">
            <img src="assets/model-a.jpg" alt="Model A">
            <h3>Model A</h3>
            <p>Long range, fast charging, advanced driver assistance.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-b.jpg" alt="Model B">
            <h3>Model B</h3>
            <p>Urban performance with compact design and premium interior.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-c.jpg" alt="Model C">
            <h3>Model C</h3>
            <p>An intelligent SUV with family-friendly range and space.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
        </div>
      </div>
    </section>
    <section class="about-teaser">
      <div class="container">
        <h2>Our Vision</h2>
        <p>We build electric vehicles that are safe, sustainable and delightful to drive. Technology and design come
          together to make mobility more efficient and enjoyable.</p>
        <p><a class="btn ghost" href="about.html">Learn about us</a></p>
      </div>
    </section>
  </main>
  <footer class="site-footer">
    <div class="container">
      <div>© 2025 LeapReplica</div>
      <nav class="foot-nav">
        <a href="privacy.html">Privacy</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </footer>
  <!-- Salesforce Embedded Messaging Script -->
<!-- Salesforce Embedded Messaging Script + Custom Styles -->
<script type="text/javascript">
function initEmbeddedMessaging() {
  try {
    embeddedservice_bootstrap.settings.language = "es";

    window.addEventListener("onEmbeddedMessagingReady", () => {
      embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
        Country: "Spain",
        Language: "es",
        CountryCode: "es",
      });
    });

    embeddedservice_bootstrap.settings.chatButtonPosition = "60px, 30px";

    embeddedservice_bootstrap.init(
      "00DMA000003XnGM",
      "LPM_Leapmotor",
      "https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231",
      { scrt2URL: "https://leapmotor--dev01.sandbox.my.salesforce-scrt.com" }
    );
  } catch (err) {
    console.error("Error loading Embedded Messaging:", err);
  }
}

(function () {
  const NUDGE_DELAY_MS = 30000;
  const DESKTOP_MIN_WIDTH = 1025;

  let firstTimer = null;
  let followupTimer = null;
  let followupScheduled = false;
  let nudge = null;
  let lastIsOpen = null;
  let statePoller = null;

  /* ===== UTILS ===== */
  function getLauncherEl() {
    return (
      document.querySelector(".embeddedServiceLauncher") ||
      document.querySelector(".embeddedServiceSidebarButton")
    );
  }

  function getChatFrameEl() {
    return (
      document.querySelector(".embeddedMessagingFrame") ||
      document.querySelector('iframe[src*="embeddedmessaging"]')
    );
  }

  function getFixedRootEl() {
    const frame = getChatFrameEl();
    if (!frame) return null;
    let el = frame;
    while (el && el !== document.body) {
      if (getComputedStyle(el).position === "fixed") return el;
      el = el.parentElement;
    }
    return document.querySelector("#embedded-messaging");
  }

let invisibleBootstrapDone = false;

function invisibleBootstrapOpenClose() {
  if (invisibleBootstrapDone) return;

  try {
    // Apri la chat
    embeddedservice_bootstrap?.open?.();

    // Nascondi subito qualsiasi UI visibile
    const hideStyles = () => {
      const frame = getChatFrameEl();
      const root = getFixedRootEl();
      const target = frame || root;
      if (!target) return;

      target.style.opacity = "0";
      target.style.pointerEvents = "none";
      target.style.transform = "translateY(100px)";
      target.style.transition = "none";
    };

    // Applica più volte finché il DOM esiste
    const h1 = setInterval(() => {
      hideStyles();
      if (getChatFrameEl()) clearInterval(h1);
    }, 30);

    // Chiudi rapidamente (prima che venga mostrato qualsiasi messaggio)
    setTimeout(() => {
      embeddedservice_bootstrap?.close?.();

      // Ripristina completamente lo stato visivo
      setTimeout(() => {
        const frame = getChatFrameEl();
        const root = getFixedRootEl();
        const target = frame || root;
        if (!target) return;

        target.style.opacity = "";
        target.style.pointerEvents = "";
        target.style.transform = "";
        target.style.transition = "";

        invisibleBootstrapDone = true;
      }, 50);
    }, 80);

  } catch (e) {
    console.warn("Invisible bootstrap skipped", e);
  }
}


  /* ===== POSIZIONI ===== */
  function lockLauncherStyle() {
    const launcher = getLauncherEl();
    if (!launcher) return;

    launcher.style.position = "fixed";
    launcher.style.bottom = "60px";
    launcher.style.right = "30px";
    launcher.style.left = "auto";
    launcher.style.top = "auto";
    launcher.style.transform = "none";
    launcher.style.zIndex = "2147483647";

    updateNudgePosition();
  }


function lockFixedRootStyle() {
  if (window.innerWidth < DESKTOP_MIN_WIDTH) return;

  const frame = getChatFrameEl();   // iframe .embeddedMessagingFrame
  const root  = getFixedRootEl();   // #embedded-messaging o il primo fixed ancestor

  // Parametri di posizionamento
  const bottom = "40px";
  const right  = "30px";

  // Helper per forzare con !important
  function forceFixed(el) {
    if (!el) return;
    const s = el.style;
    s.setProperty("position", "fixed", "important");
    s.setProperty("bottom", bottom, "important");
    s.setProperty("right",  right,  "important");
    s.setProperty("left",   "auto", "important");
    s.setProperty("top",    "auto", "important");
    // Inset coerente, così copriamo sia bottom/right che layout moderni
    s.setProperty("inset", `auto ${right} ${bottom} auto`, "important");
    s.setProperty("z-index", "2147483645", "important");

  }

  // Applica ad entrambi: chiunque sia “il vero fixed” risulterà corretto
  forceFixed(root);
  forceFixed(frame);
}



function observeFixedRoot() {
  const root  = getFixedRootEl();
  const frame = getChatFrameEl();
  const targets = [root, frame].filter(Boolean);
  if (!targets.length) return;

  const observer = new MutationObserver(() => lockFixedRootStyle());
  for (const t of targets) {
    observer.observe(t, { attributes: true, attributeFilter: ["style", "class"] });
  }
}


  /* ===== NUDGE ===== */
  function showNudge(message) {
    if (nudge) return;

    nudge = document.createElement("div");
    nudge.className = "chat-nudge";
    nudge.textContent = message;

    const closeBtn = document.createElement("span");
    closeBtn.className = "close-btn";
    closeBtn.textContent = "×";
    closeBtn.onclick = (e) => {
      e.stopPropagation();
      removeNudge();
    };
    nudge.appendChild(closeBtn);

    nudge.onclick = () => {
      window.embeddedservice_bootstrap?.open?.();
      removeNudge();
    };

    document.body.appendChild(nudge);
    updateNudgePosition();
  }

  function removeNudge() {
    if (nudge) {
      nudge.remove();
      nudge = null;
    }
  }

  function updateNudgePosition() {
    const launcher = getLauncherEl();
    if (launcher && nudge) {
      const rect = launcher.getBoundingClientRect();
      const bottom = Math.max(0, window.innerHeight - rect.top + 20);
      nudge.style.bottom = bottom + "px";
    }
  }

  /* ===== STATO CHAT ===== */
  function isOpenState() {
    const frame = getChatFrameEl();
    const root = getFixedRootEl();
    if (!frame || !root) return false;

    const fr = frame.getBoundingClientRect();
    const rr = root.getBoundingClientRect();
    return fr.height > 150 && fr.width > 200 && rr.height > 150;
  }

let firstOpenFixApplied = false;

function applyFirstOpenVisualFix() {
  if (firstOpenFixApplied) return;

  const frame = getChatFrameEl();
  const root = getFixedRootEl();
  const target = frame || root;
  if (!target) return;

  target.style.transform = "translateY(-40px)";
  target.style.transition = "transform 0.15s ease-out";

  firstOpenFixApplied = true;
}


  function evaluateAndApplyOpenState() {
    const nowOpen = isOpenState();

    /* OPEN → MINIMIZED */
    if (lastIsOpen === true && !nowOpen) {
      if (!followupScheduled) {
        followupScheduled = true;
        followupTimer = setTimeout(() => showNudge("¡Sigue hablándome!"), NUDGE_DELAY_MS);
      }
    }

    /* MINIMIZED → OPEN */
    if (lastIsOpen === false && nowOpen) {
      followupScheduled = false;
      if (followupTimer) clearTimeout(followupTimer);
      removeNudge();
    }

    lastIsOpen = nowOpen;
  }

  function startStatePolling() {
    lastIsOpen = isOpenState();
    statePoller = setInterval(evaluateAndApplyOpenState, 700);
  }

  /* ===== EVENTI ===== */
  window.addEventListener("onEmbeddedMessagingReady", () => {
    document.body.classList.add("chat-launcher-fixed");

    lockLauncherStyle();
    lockFixedRootStyle();
    observeFixedRoot();

    // Retry differito per forzare offset iniziale
    setTimeout(() => {
    lockLauncherStyle();
    lockFixedRootStyle();
    }, 200);

    setTimeout(() => {
    lockLauncherStyle();
    lockFixedRootStyle();
    }, 600); // <<< aggiunto secondo retry per apertura iniziale

    startStatePolling();
    setTimeout(invisibleBootstrapOpenClose, 400);
    if (firstTimer) clearTimeout(firstTimer);
    firstTimer = setTimeout(() => {
    if (!isOpenState()) showNudge("¡Habla conmigo!");
    }, NUDGE_DELAY_MS);
  });

  window.addEventListener("onEmbeddedMessagingButtonClicked", () => {
  invisibleBootstrapDone = true;
    setTimeout(evaluateAndApplyOpenState, 300);
  });




window.addEventListener("onEmbeddedMessagingWindowOpened", () => {
  removeNudge();
  followupScheduled = false;
  lastIsOpen = true;


  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      applyFirstOpenVisualFix();
    });
  });
});



  window.addEventListener("onEmbeddedMessagingWindowMinimized", () => {
    lockFixedRootStyle();
    setTimeout(evaluateAndApplyOpenState, 300);
  });
})();
</script>

<style>
:root {
  --chat-launcher-bottom: 60px;
  --chat-launcher-right: 30px;
  --chat-nudge-offset: 70px;
  --chat-header-height: 60px;
  --site-header-height: 60px;
}

/* DESKTOP */
@media (min-width: 1025px) {
  .embeddedMessagingFrame {
    border-radius: 16px !important;
    overflow: hidden !important;
  }
  .embeddedMessagingHeader {
    border-top-left-radius: 16px !important;
    border-top-right-radius: 16px !important;
  }
  .embeddedMessagingConversation {
    border-bottom-left-radius: 16px !important;
    border-bottom-right-radius: 16px !important;
  }
  /* sicurezza offset chat */
  #embedded-messaging {
    bottom: 40px !important;
    right: 30px !important;
  }
}

/* LAUNCHER */
.chat-launcher-fixed .embeddedServiceLauncher,
.chat-launcher-fixed .embeddedServiceSidebarButton {
  position: fixed !important;
  bottom: var(--chat-launcher-bottom) !important;
  right: var(--chat-launcher-right) !important;
  left: auto !important;
  top: auto !important;
  transform: none !important;
  z-index: 2147483647 !important;
}

/* NUDGE */
.chat-nudge {
  position: fixed;
  bottom: calc(var(--chat-launcher-bottom) + var(--chat-nudge-offset));
  right: var(--chat-launcher-right);
  background: #fff;
  color: #000;
  padding: 10px 32px 10px 12px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  z-index: 2147483646;
  animation: bounce 5s ease-out;
}
.chat-nudge .close-btn {
  position: absolute;
  top: 4px;
  right: 6px;
  font-size: 14px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
}
.chat-nudge .close-btn:hover {
  color: #000;
}
@keyframes bounce {
  0%,40%,80%,100% { transform: translateY(0); }
  20% { transform: translateY(-6px); }
  60% { transform: translateY(-3px); }
}

/* MOBILE/TABLET */
@media (max-width: 1024px) {
  body.esw-open {
    overflow: hidden;
  }
  .esw-open #embedded-messaging {
    position: fixed !important;
    top: var(--site-header-height, var(--chat-header-height)) !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: calc(100dvh - var(--site-header-height, var(--chat-header-height))) !important;
    border-radius: 0 !important;
    z-index: 2147483645 !important;
  }
  .chat-launcher-fixed .embeddedServiceLauncher,
  .chat-launcher-fixed .embeddedServiceSidebarButton {
    bottom: 20px !important;
    right: 20px !important;
  }
  .chat-nudge {
    bottom: calc(20px + var(--chat-nudge-offset));
    right: 20px;
    font-size: 13px;
  }
}
</style>
  <!-- Load Salesforce Embedded Messaging Bootstrap -->
  <script
    type="text/javascript"
    src="https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231/assets/js/bootstrap.min.js"
    onload="initEmbeddedMessaging()"
  ></script>
</body>
</html>
