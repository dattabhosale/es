<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeapReplica - Electric Vehicles</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="/" class="brand">LeapReplica</a>
      <nav class="site-nav" id="site-nav">
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">☰</button>
    </div>
  </header>
  <main>
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-copy">
          <h1>Electric mobility, designed for the future.</h1>
          <p>Explore a new generation of electric vehicles with long range, smart features, and bold design.</p>
          <p><a class="btn" href="products.html">View Models</a></p>
        </div>
        <div class="hero-media">
          <img src="assets/car-hero.jpg" alt="Electric car mockup">
        </div>
      </div>
    </section>
    <section class="highlights">
      <div class="container">
        <h2>Featured Models</h2>
        <div class="cards">
          <article class="card">
            <img src="assets/model-a.jpg" alt="Model A">
            <h3>Model A</h3>
            <p>Long range, fast charging, advanced driver assistance.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-b.jpg" alt="Model B">
            <h3>Model B</h3>
            <p>Urban performance with compact design and premium interior.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
          <article class="card">
            <img src="assets/model-c.jpg" alt="Model C">
            <h3>Model C</h3>
            <p>An intelligent SUV with family-friendly range and space.</p>
            <p><a class="link" href="products.html">Learn more</a></p>
          </article>
        </div>
      </div>
    </section>
    <section class="about-teaser">
      <div class="container">
        <h2>Our Vision</h2>
        <p>We build electric vehicles that are safe, sustainable and delightful to drive. Technology and design come
          together to make mobility more efficient and enjoyable.</p>
        <p><a class="btn ghost" href="about.html">Learn about us</a></p>
      </div>
    </section>
  </main>
  <footer class="site-footer">
    <div class="container">
      <div>© 2025 LeapReplica</div>
      <nav class="foot-nav">
        <a href="privacy.html">Privacy</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </footer>
  <!-- Salesforce Embedded Messaging Script -->
<!-- Salesforce Embedded Messaging Script + Custom Styles -->
<script type="text/javascript">
function initEmbeddedMessaging() {
  try {
    embeddedservice_bootstrap.settings.language = "es";
 
    window.addEventListener("onEmbeddedMessagingReady", () => {
      embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
        Country: "Spain",
        Language: "es",
        CountryCode: "es",
      });
    });
 
    // Fallback posizione launcher (Salesforce può ignorarla; la manteniamo)
    embeddedservice_bootstrap.settings.chatButtonPosition = '60px, 30px';
 
    embeddedservice_bootstrap.init(
      "00DMA000003XnGM",
      "LPM_Leapmotor",
      "https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231",
      { scrt2URL: "https://leapmotor--dev01.sandbox.my.salesforce-scrt.com" }
    );
  } catch (err) {
    console.error("Error loading Embedded Messaging: ", err);
  }
}
 
// ======================== ENHANCED CONTROL SCRIPT =========================
(function () {
  let chatOpened = false;
  let firstTimer = null;
  let followupTimer = null;
  let nudge = null;
  let launcherObserver = null;
  let bodyObserver = null;
  let containerObserver = null;
 
  // Watcher di visibilità/minimizzazione (migliorato)
  let visInterval = null;
  let lastMinimizedState = null;
 
  /* ---------- Helpers sito: header e banner ---------- */
  function getHeaderEl() {
    const fromAttr = document.body?.getAttribute?.("data-esw-header");
    const candidates = (fromAttr ? fromAttr.split(",") : []).map(s => s.trim()).filter(Boolean);
 
    const defaults = [
      "header.site-header","header.navbar","header#header","#site-header",
      "header.header","header",".topbar",".navbar",
    ];
    const list = [...candidates, ...defaults];
    for (const sel of list) {
      const el = document.querySelector(sel);
      if (el) return el;
    }
    return null;
  }
 
  function getBottomBannerEl() {
    const fromAttr = document.body?.getAttribute?.("data-esw-banner") || "";
    const candidates = (fromAttr ? fromAttr.split(",") : []).map(s => s.trim()).filter(Boolean);
    const defaults = [
      "#cookie-banner",".cookie-banner",".cookieConsentContainer",
      "#consent-banner",".sticky-bottom","footer.sticky-footer",
    ];
    const list = [...candidates, ...defaults];
    for (const sel of list) {
      const el = document.querySelector(sel);
      if (el && isElementVisible(el)) return el;
    }
    return null;
  }
 
  function isElementVisible(el) {
    const style = window.getComputedStyle(el);
    if (style.display === "none" || style.visibility === "hidden" || style.opacity === "0") return false;
    const rect = el.getBoundingClientRect();
    return rect.width > 0 && rect.height > 0;
  }
 
  function updateHeaderHeightVar() {
    const header = getHeaderEl();
    const h = header ? header.offsetHeight : 60;
    document.documentElement.style.setProperty("--site-header-height", h + "px");
  }
 
  function updateLauncherBottomForBanner() {
    const banner = getBottomBannerEl();
    const base = 60; // default launcher
    let offset = base;
 
    if (banner) {
      const rect = banner.getBoundingClientRect();
      if (rect.height > 0) {
        offset = Math.max(base, rect.height + 16);
      }
    }
    document.documentElement.style.setProperty("--chat-launcher-bottom", offset + "px");
    requestAnimationFrame(() => setTimeout(lockLauncherStyle, 50));
  }
 
  /* ---------- Selettori ESW ---------- */
  function getLauncherEl() {
    return (
      document.querySelector(".embeddedServiceLauncher") ||
      document.querySelector(".embeddedServiceSidebarButton") ||
      document.querySelector('[data-embedded-messaging-launcher]') ||
      document.querySelector('#embedded-messaging .embeddedMessagingIcon') ||
      document.querySelector('#embedded-messaging button') ||
      document.querySelector('button[class*="Launcher"], div[class*="Launcher"]')
    );
  }
 
  // Container root di Embedded Messaging (quello che va sollevato di 40px)
  function getChatContainerEl() {
    return (
      document.querySelector("#embedded-messaging") ||
      document.querySelector('[data-embedded-messaging-root]') ||
      document.querySelector('div[id*="embeddedMessaging"], div[class*="embeddedMessaging"]')
    );
  }
 
  // iFrame della conversazione (spesso dentro il container)
  function getChatFrameEl() {
    return (
      document.querySelector(".embeddedMessagingFrame") ||
      document.querySelector('iframe[data-embedded-messaging-iframe]') ||
      document.querySelector('iframe[src*="embeddedmessaging"]') ||
      document.querySelector('iframe[id*="embeddedMessaging"]')
    );
  }
 
  /* ---------- Spostamento e lock: launcher + container ---------- */
  function lockLauncherStyle() {
    const launcher = getLauncherEl();
    if (!launcher) return;
 
    const cs = getComputedStyle(document.documentElement);
    const bottom = cs.getPropertyValue("--chat-launcher-bottom").trim() || "60px";
    const right = cs.getPropertyValue("--chat-launcher-right").trim() || "30px";
 
    launcher.style.position = "fixed";
    launcher.style.bottom = bottom;
    launcher.style.right = right;
    launcher.style.left = "auto";
    launcher.style.top = "auto";
    launcher.style.transform = "none";
    launcher.style.transition = "none";
    launcher.style.zIndex = "2147483647";
 
    updateNudgePosition();
  }
 
  // **NUOVO**: sposta il CONTAINER root a 40px dal fondo su desktop
  function lockContainerStyle() {
    const container = getChatContainerEl();
    if (!container) return;
 
    // Solleva di 40px dal fondo solo su desktop; su mobile lo gestiamo full-screen
    const gap = getComputedStyle(document.documentElement)
      .getPropertyValue("--chat-frame-bottom-gap").trim() || "40px";
 
    const rightGap = getComputedStyle(document.documentElement)
      .getPropertyValue("--chat-frame-right-gap").trim() || "30px";
 
    // Il container spesso è already fixed; imponiamo la nostra posizione
    container.style.position = "fixed";
    container.style.bottom = gap;
    container.style.right = rightGap;
    container.style.left = "auto";
    container.style.top = "auto";
    container.style.zIndex = "2147483645"; // sotto il launcher
  }
 
  function observeLauncher() {
    if (launcherObserver) { launcherObserver.disconnect(); launcherObserver = null; }
    const launcher = getLauncherEl();
    if (!launcher) return;
 
    launcherObserver = new MutationObserver(() => {
      lockLauncherStyle();
    });
    launcherObserver.observe(launcher, { attributes: true, attributeFilter: ["style", "class", "aria-pressed", "aria-expanded"] });
 
    // Intercetta anche i click sul launcher per capire toggle open/minimize
    launcher.addEventListener("click", onLauncherClick, { capture: true });
  }
 
  // **NUOVO**: osserva il CONTAINER per reimporre il bottom 40px
  function observeContainer() {
    if (containerObserver) { containerObserver.disconnect(); containerObserver = null; }
    const container = getChatContainerEl();
    if (!container) return;
    containerObserver = new MutationObserver(() => {
      lockContainerStyle();
    });
    containerObserver.observe(container, { attributes: true, attributeFilter: ["style", "class"] });
  }
 
  function observeBodyForReattach() {
    if (bodyObserver) { bodyObserver.disconnect(); bodyObserver = null; }
    bodyObserver = new MutationObserver(() => {
      // Se Salesforce ricrea elementi, rilock
      if (getLauncherEl()) {
        lockLauncherStyle();
        observeLauncher();
      }
      if (getChatContainerEl()) {
        lockContainerStyle();
        observeContainer();
      }
    });
    bodyObserver.observe(document.body, { childList: true, subtree: true });
  }
 
  function rafThenTimeout(fn, delay = 0) {
    requestAnimationFrame(() => setTimeout(fn, delay));
  }
 
  /* ---------- Nudge ---------- */
  function showNudge(message) {
    if (nudge) return;
 
    nudge = document.createElement("div");
    nudge.className = "chat-nudge";
    nudge.textContent = message;
 
    const closeBtn = document.createElement("span");
    closeBtn.className = "close-btn";
    closeBtn.textContent = "×";
    closeBtn.onclick = function (e) {
      e.stopPropagation();
      removeNudge();
    };
    nudge.appendChild(closeBtn);
 
    nudge.onclick = function () {
      window.embeddedservice_bootstrap?.open?.();
      removeNudge();
    };
 
    document.body.appendChild(nudge);
    updateNudgePosition();
  }
 
  function removeNudge() {
    if (nudge) {
      nudge.remove();
      nudge = null;
    }
  }
 
  function updateNudgePosition() {
    const launcher = getLauncherEl();
    if (launcher && nudge) {
      const rect = launcher.getBoundingClientRect();
      const bottom = Math.max(0, window.innerHeight - rect.top + 20);
      nudge.style.bottom = bottom + "px";
    }
  }
 
  /* ---------- Rilevazione minimizzazione robusta ---------- */
  function isMinimizedHeuristic() {
    // Heuristics combinate su container e frame
    const container = getChatContainerEl();
    const frame = getChatFrameEl();
 
    let minimized = false;
 
    if (container) {
      const cr = container.getBoundingClientRect();
      const cs = getComputedStyle(container);
      // se il container è visibile ma con altezza molto bassa o è “nascosto”
      if (cs.display === "none" || cs.visibility === "hidden") minimized = true;
      if (cr.height <= 80) minimized = true; // molte UIs riducono a un launcher/mini
      // se è a bottom pieno (0) quando dovrebbe essere > 0 in desktop, lo consideriamo minimizzato
      const desiredGap = parseInt((getComputedStyle(document.documentElement).getPropertyValue("--chat-frame-bottom-gap") || "40").replace("px",""), 10);
      const bottomIsZero = Math.abs((window.innerHeight - cr.bottom)) < 2; // attaccato al fondo
      if (bottomIsZero && desiredGap >= 40) minimized = true;
    }
 
    if (frame && !minimized) {
      const fr = frame.getBoundingClientRect();
      const fs = getComputedStyle(frame);
      if (fs.display === "none" || fs.visibility === "hidden") minimized = true;
      if (fr.height <= 80) minimized = true;
    }
 
    return minimized;
  }
 
  function triggerMinimizedFlow() {
    // logica unica per minimizzazione (evento o heuristic)
    chatOpened = false;
    document.body.classList.remove("esw-open");
 
    rafThenTimeout(lockLauncherStyle, 50);
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 200);
 
    if (followupTimer) clearTimeout(followupTimer);
    followupTimer = setTimeout(() => {
      showNudge("¡Sigue hablándome!");
    }, 30000);
  }
 
  function startVisibilityWatcher() {
    if (visInterval) clearInterval(visInterval);
    lastMinimizedState = isMinimizedHeuristic();
    visInterval = setInterval(() => {
      const nowMin = isMinimizedHeuristic();
      if (lastMinimizedState !== nowMin) {
        // Transizione di stato
        if (nowMin) {
          // appena minimizzato
          triggerMinimizedFlow();
        } else {
          // appena espanso
          chatOpened = true;
          document.body.classList.add("esw-open");
          removeNudge();
        }
      }
      lastMinimizedState = nowMin;
    }, 700);
  }
 
  function stopVisibilityWatcher() {
    if (visInterval) {
      clearInterval(visInterval);
      visInterval = null;
    }
  }
 
  // Intercetto i click del launcher per dedurre il toggle open/minimize
  function onLauncherClick() {
    const launcher = getLauncherEl();
    if (!launcher) return;
    // Molti launchers aggiornano aria-pressed/expanded
    const pressed = launcher.getAttribute("aria-pressed");
    const expanded = launcher.getAttribute("aria-expanded");
 
    // Piccolo delay per lasciare aggiornare lo stato al widget
    setTimeout(() => {
      const isPressed = launcher.getAttribute("aria-pressed") === "true";
      const isExpanded = launcher.getAttribute("aria-expanded") === "true";
      // Heuristic: se prima era open e ora non è expanded/pressed → minimizzato
      if (chatOpened && !(isPressed || isExpanded)) {
        triggerMinimizedFlow();
      } else if (!chatOpened && (isPressed || isExpanded)) {
        chatOpened = true;
        document.body.classList.add("esw-open");
        removeNudge();
      }
    }, 50);
  }
 
  /* ---------- Eventi Embedded Messaging ---------- */
  window.addEventListener("onEmbeddedMessagingReady", function () {
    document.body.classList.add("chat-launcher-fixed");
 
    updateHeaderHeightVar();
    updateLauncherBottomForBanner();
 
    // Blocca subito (e in più step per superare animazioni)
    lockLauncherStyle();
    lockContainerStyle();
    observeLauncher();
    observeContainer();
    observeBodyForReattach();
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 50);
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 200);
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 400);
 
    window.addEventListener("resize", () => {
      updateHeaderHeightVar();
      updateLauncherBottomForBanner();
      updateNudgePosition();
      rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 50);
    });
 
    // Nudge iniziale (se non aperta)
    if (firstTimer) clearTimeout(firstTimer);
    firstTimer = setTimeout(() => {
      if (!chatOpened) showNudge("¡Habla conmigo!");
    }, 30000);
 
    startVisibilityWatcher();
  });
 
  window.addEventListener("onEmbeddedMessagingButtonClicked", function () {
    chatOpened = true;
    removeNudge();
    if (firstTimer) clearTimeout(firstTimer);
    if (followupTimer) clearTimeout(followupTimer);
  });
 
  window.addEventListener("onEmbeddedMessagingWindowOpened", function () {
    chatOpened = true;
    document.body.classList.add("esw-open");
    updateHeaderHeightVar();
    updateLauncherBottomForBanner();
 
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 50);
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 200);
  });
 
  window.addEventListener("onEmbeddedMessagingWindowMinimized", function () {
    // Se l’SDK emette l’evento, bene: avviamo la stessa logica
    triggerMinimizedFlow();
  });
 
  window.addEventListener("onEmbeddedMessagingWindowClosed", function () {
    document.body.classList.remove("esw-open");
    chatOpened = false;
    rafThenTimeout(() => { lockLauncherStyle(); lockContainerStyle(); }, 50);
    stopVisibilityWatcher();
  });
 
  window.addEventListener("orientationchange", () => {
    updateHeaderHeightVar();
    updateLauncherBottomForBanner();
    rafThenTimeout(() => {
      updateNudgePosition();
      lockLauncherStyle();
      lockContainerStyle();
    }, 100);
  });
})();
</script>
 
<!-- Custom Styles for Embedded Messaging Chat -->
<style>
:root {
  /* Launcher (bottone) */
  --chat-launcher-bottom: 60px;
  --chat-launcher-right: 30px;
 
  /* Nudge */
  --chat-nudge-offset: 70px;
 
  /* Header mobile */
  --chat-header-height: 60px;   /* fallback */
  --site-header-height: 60px;   /* calcolata via JS */
 
  /* Desktop: solleva il CONTAINER della chat di 40px dal fondo */
  --chat-frame-bottom-gap: 40px;  /* <<< richiesta */
  --chat-frame-right-gap: 30px;   /* allineato al launcher */
}
 
/* ======= DESKTOP ======= */
/* Lasciamo che ESW gestisca dimensioni/rounding sul frame; spostiamo il CONTAINER via JS */
@media (min-width: 1025px) {
  .embeddedMessagingFrame {
    border-radius: 16px !important;
    overflow: hidden !important;
    /* niente transform, niente bottom qui: lo fa il container */
    z-index: 2147483645 !important;
  }
  .embeddedMessagingHeader {
    border-top-left-radius: 16px !important;
    border-top-right-radius: 16px !important;
  }
  .embeddedMessagingConversation {
    border-bottom-left-radius: 16px !important;
    border-bottom-right-radius: 16px !important;
  }
}
 
/* ======= LAUNCHER BLOCCATO ======= */
.chat-launcher-fixed .embeddedServiceLauncher,
.chat-launcher-fixed .embeddedServiceSidebarButton,
.chat-launcher-fixed #embedded-messaging .embeddedMessagingIcon,
.chat-launcher-fixed button[class*="Launcher"],
.chat-launcher-fixed div[class*="Launcher"] {
  position: fixed !important;
  bottom: var(--chat-launcher-bottom) !important;
  right: var(--chat-launcher-right) !important;
  left: auto !important;
  top: auto !important;
  transform: none !important;
  z-index: 2147483647 !important;
}
 
/* ======= NUDGE ======= */
.chat-nudge {
  position: fixed;
  bottom: calc(var(--chat-launcher-bottom) + var(--chat-nudge-offset));
  right: var(--chat-launcher-right);
  background: #ffffff;
  color: #000;
  padding: 10px 32px 10px 12px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  font-size: 14px;
  font-weight: 500;
  z-index: 2147483646;
  cursor: pointer;
  animation: bounce 5s ease-out;
}
@keyframes bounce {
  0% { transform: translateY(0); }
  20% { transform: translateY(-6px); }
  40% { transform: translateY(0); }
  60% { transform: translateY(-3px); }
  80% { transform: translateY(0); }
  100% { transform: translateY(0); }
}
.chat-nudge .close-btn {
  position: absolute;
  top: 4px;
  right: 6px;
  font-weight: bold;
  font-size: 14px;
  color: #666;
  cursor: pointer;
  margin-left: 8px;
}
.chat-nudge .close-btn:hover { color: #000; }
 
/* ======= MOBILE/TABLET: full screen sotto l’header del sito ======= */
@media (max-width: 1024px) {
  body.esw-open { overflow: hidden; }
 
  /* Nota: su mobile spingiamo il frame full-screen sotto l’header;
     il container resta a bottom 0; il JS non forza il gap sul container in mobile */
  .esw-open .embeddedMessagingFrame,
  .esw-open iframe[data-embedded-messaging-iframe] {
    position: fixed !important;
    top: var(--site-header-height, var(--chat-header-height)) !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    height: calc(100dvh - var(--site-header-height, var(--chat-header-height))) !important;
    bottom: 0 !important;
    border-radius: 0 !important;
    z-index: 2147483645 !important;
  }
 
  /* Launcher mobile */
  .chat-launcher-fixed .embeddedServiceLauncher,
  .chat-launcher-fixed .embeddedServiceSidebarButton,
  .chat-launcher-fixed #embedded-messaging .embeddedMessagingIcon,
  .chat-launcher-fixed button[class*="Launcher"],
  .chat-launcher-fixed div[class*="Launcher"] {
    bottom: 20px !important;
    right: 20px !important;
    transform: none !important;
  }
 
  .chat-nudge {
    bottom: calc(20px + var(--chat-nudge-offset));
    right: 20px;
    font-size: 13px;
  }
}
</style>
  <!-- Load Salesforce Embedded Messaging Bootstrap -->
  <script
    type="text/javascript"
    src="https://leapmotor--dev01.sandbox.my.site.com/ESWLPMLeapmotor1760706603231/assets/js/bootstrap.min.js"
    onload="initEmbeddedMessaging()"
  ></script>
</body>
</html>
